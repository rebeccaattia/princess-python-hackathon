<!DOCTYPE html>
<html lang="en">

    <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>PyScript Classroom Workspace</title>

  <!-- Safari SharedArrayBuffer shim (needed for PyScript/MicroPython) -->
  <script src="https://rebeccatufts25.pyscriptapps.com/11-17-princess-python-hackathon/latest/safari-sab.js"></script>

  <!-- COOP/COEP Service Worker injection (THIS IS THE MAGIC FIX) -->
  <script>
    /*! mini-coi-serviceworker - enables SharedArrayBuffer on GH Pages + iframes */
    (({ document: d, navigator: { serviceWorker: s } }) => {
      if (d) {
        const { currentScript: c } = d;
        s.register('coi-serviceworker.js');).then(r => {
          r.addEventListener('updatefound', () => location.reload());
          if (r.active && !s.controller) location.reload();
        });
      } else {
        addEventListener('install', () => skipWaiting());
        addEventListener('activate', e => e.waitUntil(clients.claim()));
        addEventListener('fetch', e => {
          const { request: r } = e;
          if (r.cache === 'only-if-cached' && r.mode !== 'same-origin') return;
          e.respondWith(fetch(r).then(resp => {
            const { body, status, statusText } = resp;
            if (!status || status > 399) return resp;

            const h = new Headers(resp.headers);
            h.set('Cross-Origin-Opener-Policy', 'same-origin');
            h.set('Cross-Origin-Embedder-Policy', 'require-corp');
            h.set('Cross-Origin-Resource-Policy', 'cross-origin');

            return new Response(body, { status, statusText, headers: h });
          }));
        });
      }
    })(self);
  </script>


  <!-- PyScript -->
  <link rel="stylesheet" href="https://pyscript.net/releases/2025.10.3/core.css">
  <script type="module" src="https://pyscript.net/releases/2025.10.3/core.js"></script>

  <!-- CodeMirror -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>

  <!-- Start program from channel message -->
  <script>
    // Called from your channel code â€“ will run CodeMirror code in the REPL
    window.triggerChannelMessage = (value) => {
      console.log("ðŸŽ¯ Channel trigger:", value);
      if (typeof runEditorInRepl === "function") {
        runEditorInRepl();
      } else {
        console.warn("runEditorInRepl not ready yet.");
      }
    };
  </script>

  <!-- Called from Python when _user_program finishes -->
  <script>
    window.onProgramFinished = function() {
      console.log("âœ… Program finished (onProgramFinished called)");
      if (window.channel_posttrigger) {
        window.channel_posttrigger();
      }
    };
  </script>

  <!-- Fonts (if you ever want Koulen again) -->
  <link href="https://fonts.googleapis.com/css2?family=Koulen&display=swap" rel="stylesheet">

  <style>
    :root {
      --border:#dcdcdc;
      --gutter:35px;
      --dark-bg:#0b0f14;
      --dark-fg:#e8f5e9;
      --accent-yellow:#f7cf3c;
      --panel-bg:#f9f9f9;
      --pink:#ff4aa2;
      --connect-blue:#4c8edb;
    }

    body {
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:#fff;
      height:100vh;
      display:flex;
      flex-direction:column;
      overflow:hidden; /* keep everything on one screen */
    }

    /* Main workspace: 2 rows (top: channels/connect, bottom: code + REPL) */
    .workspace {
      flex:1;
      display:grid;
      grid-template-rows:auto 1fr;
      gap:var(--gutter);
      padding:var(--gutter);
      box-sizing:border-box;
      min-height:0;
    }

    .top-row {
      min-height:0;
    }

    .bottom-row {
      display:grid;
      grid-template-columns:minmax(0,1.3fr) minmax(0,1fr); /* Code It | REPL */
      gap:25px;
      min-height:0;
    }

    .panel {
      background:#fff;
      border-radius:6px;
      padding:8px;
      box-sizing:border-box;
      min-height:0;
      min-width:0;
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
      display:flex;
      flex-direction:column;
    }

    /* ===== TOP: single master panel containing BOTH Channel It + Connect It ===== */
    #top-master-panel {
      border:none;          /* inner boxes get colored borders */
      padding:0;
      background:transparent;
      box-shadow:none;
    }

    .top-inner {
      display:flex;
      gap:25px;             /* requested spacing between the two boxes */
      align-items:stretch;
    }

    .top-box {
      flex:1;
      background:#fff;
      border-radius:6px;
      padding:20px 20px;
      box-sizing:border-box;
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
      display:flex;
      flex-direction:column;
      min-width:0;
    }

    /* Keep DOM order as: Connect -> Channel (for scripts),
       but visually show Channel on the LEFT. */
    .connect-box {
      border:3px solid var(--connect-blue);
      order:1; /* appear on RIGHT */
    }

    .channel-box {
      border:3px solid var(--accent-yellow);
      order:0; /* appear on LEFT */
    }

    .top-title {
      font-family:"Koulen",sans-serif;
      font-size:26px;
      margin-bottom:6px;
    }

    .top-title.channel {
      color:#e09a00;
    }

    .top-title.connect {
      color:#1f5d9f;
    }

    /* Let modules style their own contents */
    #all_things_channels,
    #hub1,
    #hub2 {
      width:100%;
    }

    /* ===== BOTTOM LEFT: Code It ===== */
    #code-panel {
      border:3px solid var(--pink);
    }

    .code-title {
      font-family:"Koulen",sans-serif;
      font-size:26px;
      color:var(--pink);
      margin:4px 4px 10px;
    }

    .code-grid {
      flex:1;
      display:grid;
      grid-template-columns:260px minmax(0,1fr);
      gap:16px;
      min-height:0;
    }

    /* Snippet bank */
    #bank {
      display:flex;
      flex-direction:column;
      min-width:0;
      max-width:100%;
      overflow:hidden;
    }

    #snippets {
      flex:1;
      overflow-y:auto;
      padding-right:4px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .snippet {
      background:#f4f4f4;
      border:1px solid #ddd;
      padding:10px 12px;
      cursor:grab;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas;
      border-radius:6px;
      box-shadow:0 1px 2px rgba(0,0,0,0.12);
    }

    .snippet .editable-arg {
      background:#fff;
      border-radius:6px;
      padding:0 6px;
      border:1px solid #ddd;
      font-weight:500;
    }

    .snippet-expl {
      font-size:11px;
      color:#333;
      margin-top:4px;
      line-height:1.2em;
      font-family:system-ui,sans-serif;
      opacity:0.85;
    }

    .snippet:active {
      cursor: grabbing;
      transform: scale(0.98);
    }

    .snippet:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.35);
    }

    .editor-layout {
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:0;
    }

    .editor-wrapper {
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
    }

    .CodeMirror {
      flex:1;
      border:1px solid var(--border);
      border-radius:6px;
      background:#fff;
      height:100%;
    }

    .button-row {
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:6px;
      align-items:center;
    }

    .button-row button {
      padding:6px 10px;
      font-size:12px;
      cursor:pointer;
      background:#fff;
      border:1px solid #ccc;
      border-radius:4px;
      font-family:system-ui;
      transition:0.15s;
    }

    .button-row button:hover {
      background:#f7cf3c;
      border-color:#d1a500;
    }

    /* Pink play button bottom-right */
    #REPLRun {
      width:36px;
      height:36px;
      border-radius:6px;
      background:#ff4aa2;
      border:none;
      color:#fff;
      font-size:20px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 2px 4px rgba(0,0,0,0.2);
    }

    #REPLRun:hover {
      filter:brightness(1.1);
    }

    /* ===== BOTTOM RIGHT: REPL ===== */
    #replPanel {
      background:var(--dark-bg);
      color:var(--dark-fg);
      border:3px solid #000;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas;
      font-size:12px;
    }

    #replPanel .section-title {
      font-family:system-ui,sans-serif;
      font-weight:500;
      font-size:14px;
      margin-bottom:4px;
      color:#fff;
      border-bottom:none;
    }

    #replPanel button {
      padding:4px 8px;
      font-size:11px;
      cursor:pointer;
      background:#111;
      border:1px solid #444;
      border-radius:4px;
      color:#eee;
    }

    #replPanel button:hover {
      background:#222;
    }

    #replContainer {
      flex:1;
      overflow:auto;
      border:1px solid #2a2a2a;
      padding:4px;
      background:var(--dark-bg);
      min-height:0;
      border-radius:6px;
      max-height:400px; /* keep it from swallowing the whole screen */
    }

    .logbox {
      border:1px solid var(--border);
      background:#fff;
      flex:1;
      overflow:auto;
      padding:4px;
      min-height:60px;
      border-radius:6px;
    }

    input.trigger {
      font-size:16px;
      padding:10px;
      width:90%;
      border:1px solid var(--border);
      border-radius:6px;
      font-family:system-ui,sans-serif;
    }

    .trigger-box {
      margin-bottom:10px;
      border:1px solid var(--border);
      padding:8px;
      background:#f3f3f3;
      border-radius:6px;
    }

    .trigger-box label {
      font-size:14px;
      font-weight:500;
      margin-bottom:4px;
      display:block;
      font-family:system-ui,sans-serif;
    }
  </style>
</head>
<body>
  <script>
    window.channel = window.channel || {};
    window.onChannelMessage = msg => console.log("Channel message:", msg);
  </script>

  <div class="workspace">
    <!-- ========= TOP: one master panel, two inner boxes ========= -->
    <div class="top-row">
      <section class="panel" id="top-master-panel">
        <div class="top-inner">
          <!-- DOM order: Connect then Channel so 4_techElements runs before 3_channels,
               but CSS order shows Channel on the LEFT. -->

          <!-- CONNECT IT (right visually, first in DOM) -->
          <div class="top-box connect-box">
            <div class="top-title connect">Connect It</div>

            <!-- Hub 1 -->
            <div id="hub1"></div>

            <!-- Hub 2 (initially hidden) -->
            <div id="hub2"></div>

            <!-- Add More Button (currently commented out in HTML)
                 If you uncomment this button, the JS handler below will start working. -->
            <!--
            <button 
              id="addMoreBtn" 
              style="
                align-self:flex-start;
                margin-top:10px;
                padding:6px 12px;
                font-size:14px;
                cursor:pointer;
                border-radius:6px;
                background:#ececec;
                border:1px solid var(--border);
                white-space:nowrap;
              "
            >
              Add More
            </button>
            -->

            <!-- Tech Elements Script -->
            <script type="mpy" src="https://rebeccatufts25.pyscriptapps.com/11-17-princess-python-hackathon/latest/4_techElements.py" config="https://rebeccatufts25.pyscriptapps.com/11-17-princess-python-hackathon/latest/pyscript.toml" worker></script>
          </div>

          <!-- CHANNEL IT (left visually) -->
          <div class="top-box channel-box">
            <div class="top-title channel">Channel It</div>

            <div id="all_things_channels"></div>
            <script type="mpy" src="https://rebeccatufts25.pyscriptapps.com/11-17-princess-python-hackathon/latest/3_channels.py" config="https://rebeccatufts25.pyscriptapps.com/11-17-princess-python-hackathon/latest/pyscript.toml" worker></script>
          </div>
        </div>
      </section>
    </div>

    <!-- ========= BOTTOM: Code It | REPL ========= -->
    <div class="bottom-row">
      <!-- Code It -->
      <section class="panel" id="code-panel">
        <div class="code-title">Code It</div>

        <div class="code-grid">
          <!-- Snippet Bank -->
          <div id="bank">
            <div id="snippets">
              <div class="snippet" draggable="true">
                print(<span class="editable-arg">'hello!'</span>)
                <div class="snippet-expl">Prints whatever is inside the () in the REPL.</div>
              </div>
              <div class="snippet" draggable="true">
                motor.run(<span class="editable-arg">50</span>)
                <div class="snippet-expl">Starts spinning the single motor at the speed inside the ().<br><i>Use a negative number to spin opposite direction.</i></div>
              </div>
                <div class="snippet" draggable="true">
                motor.run_both(<span class="editable-arg">50</span>)
                <div class="snippet-expl">Starts spinning both sides of the dual motorat the speed inside the ().<br><i>Use a negative number to spin opposite direction.</i></div>
              </div>
            <div class="snippet" draggable="true">
                motor.run_left(<span class="editable-arg">50</span>)
                <div class="snippet-expl">Starts spinning the left side of the dual motor .</div>
              </div>
                <div class="snippet" draggable="true">
                motor.run_right(<span class="editable-arg">50</span>)
                <div class="snippet-expl">Starts spinning the right side of the dual motor.</div>
              </div>
              <div class="snippet" draggable="true">
                motor.stop()
                <div class="snippet-expl">Stops the motor.</div>
              </div>
              <div class="snippet" draggable="true">
                motor.set_speed(<span class="editable-arg">50</span>)
                <div class="snippet-expl">Sets motor speed to the percentage inside the ().</div>
              </div>
              <div class="snippet" draggable="true">
                motor.angle
                <div class="snippet-expl">Returns the motor's current angle (0â€“359).</div>
              </div>
              <div class="snippet" draggable="true">
                time.sleep(<span class="editable-arg">1</span>)
                <div class="snippet-expl">Pauses program for a number of seconds.</div>
              </div>
              <div class="snippet" draggable="true">
                channel.send(<span class="editable-arg">'message'</span>)
                <div class="snippet-expl">Sends a message to the current channel.</div>
              </div>
            </div>
          </div>

          <!-- Editor + buttons -->
          <div class="editor-layout">
            <div class="editor-wrapper">
              <textarea id="code-editor"></textarea>
            </div>

            <div class="button-row">
              <button id="saveCode">Save</button>
              <button id="clearCode">Clear</button>
              <button id="downloadCode">Download</button>
              <button id="REPLRun">&#9654;</button>
            </div>
          </div>
        </div>
      </section>

      <!-- REPL -->
      <section class="panel" id="replPanel">
        <div class="section-title">REPL</div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-bottom:4px;">
          <button id="clearRepl">Clear REPL</button>
        </div>
        <div id="replContainer">
          <script id="python-terminal" type="mpy" src="https://rebeccatufts25.pyscriptapps.com/11-17-princess-python-hackathon/latest/main_copy.py" config="https://rebeccatufts25.pyscriptapps.com/11-17-princess-python-hackathon/latest/pyscript.toml" env="image" terminal worker></script>
        </div>
      </section>
    </div>
  </div>

  <!-- ================= JS ================= -->
  <script>
    const cm = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
      mode:'python', lineNumbers:true, indentUnit:4, smartIndent:true,
    });
    window.code_editor = { editor: cm };

    // Make snippet arguments editable
    function makeArgsEditable(c){
      c.querySelectorAll('.editable-arg').forEach(a=>a.setAttribute('contenteditable','true'));
    }
    const bank = document.getElementById('snippets');
    makeArgsEditable(bank);

    // Drag & drop from snippets to CodeMirror
    bank.querySelectorAll('.snippet').forEach(sn=>{
      sn.addEventListener('dragstart',e=>{
        const codeOnly=sn.cloneNode(true);
        const expl=codeOnly.querySelector('.snippet-expl');
        if(expl) expl.remove();
        e.dataTransfer.setData('text/plain',codeOnly.textContent.trim());
      });
    });

    cm.getWrapperElement().addEventListener('dragover',e=>e.preventDefault());
    cm.getWrapperElement().addEventListener('drop',e=>{
      e.preventDefault();
      let snippetText=e.dataTransfer.getData('text/plain').trim();
      if(snippetText.startsWith('for ')){
        snippetText+='\n    # Indent code you want to loop\n    print("This repeats!")';
      }
      cm.replaceSelection((cm.getValue()?'\n':'')+snippetText);
      cm.focus();
    });

    // Local storage autosave
    const STORAGE_KEY="student_workspace_code";
    const saved=localStorage.getItem(STORAGE_KEY);
    if(saved) cm.setValue(saved);

    document.getElementById('saveCode').addEventListener('click',()=>{
      localStorage.setItem(STORAGE_KEY,cm.getValue());
      alert("âœ… Code saved!");
    });

    document.getElementById('clearCode').addEventListener('click',()=>{
      if(confirm("Clear your code?")){
        cm.setValue("");
        localStorage.removeItem(STORAGE_KEY);
      }
    });

    setInterval(()=>localStorage.setItem(STORAGE_KEY,cm.getValue()),10000);

    document.getElementById('downloadCode').addEventListener('click',()=>{
      const blob=new Blob([cm.getValue()],{type:'text/x-python'});
      const link=document.createElement('a');
      link.href=URL.createObjectURL(blob);
      link.download='my_program.py';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // Turn sync code into async-friendly for REPL
    function transformCodeForAsync(code){
      // Replace blocking time.sleep() with asyncio.sleep()
      code = code.replace(/\btime\.sleep\((.*?)\)/g,"await asyncio.sleep($1)");

      // Indent user code for the async function
      const userIndented = code
        .split('\n')
        .map(l => '    ' + l)
        .join('\n');

      // Build the async wrapper and call window.onProgramFinished at the end
      const funcDef =
`import asyncio
from pyscript import window

async def _user_program():
${userIndented}

    try:
        window.onProgramFinished()
    except Exception as e:
        print("onProgramFinished error:", e)
`;

      const runner =
`loop = asyncio.get_event_loop()
loop.create_task(_user_program())
`;

      return {funcDef, runner};
    }

    function sendToRepl(parts){
      const term=document.getElementById('python-terminal');
      if(!term?.process) return false;
      try{
        term.process("\x03"); // Ctrl-C to clear any running program
        for(const line of parts.funcDef.split("\n")){
          if(line.trim()) term.process(line+"\n");
        }
        term.process("\n"+parts.runner+"\n");
        return true;
      }catch(e){
        console.error("REPL send error:",e);
        return false;
      }
    }

    // ======== AUTO-SCROLL FLAG ========
    let autoScrollRepl = true;

    function runEditorInRepl(){
      const raw=cm.getValue().trim();
      if(!raw) return;
      autoScrollRepl = true;   // re-enable autoscroll each time we run
      sendToRepl(transformCodeForAsync(raw));
    }
    window.runEditorInRepl = runEditorInRepl; // so triggerChannelMessage can see it

    document.getElementById('REPLRun').addEventListener('click',runEditorInRepl);
    cm.addKeyMap({"Shift-Enter":()=>runEditorInRepl()});

    // Clear REPL
    document.getElementById('clearRepl').addEventListener('click',()=>{
      const term=document.getElementById('python-terminal');
      if(term?.terminal?.clear) term.terminal.clear();
      else if(term?.terminal?.write) term.terminal.write('\x1bc');
      autoScrollRepl = true;  // after clearing, autoscroll to new output
    });

    // Pre-import time & asyncio once terminal is ready
    window.addEventListener('load',()=>{
      const term=document.getElementById('python-terminal');
      const autoImport=setInterval(()=>{
        if(term && typeof term.process==='function'){
          term.process('import time\n');
          term.process('import asyncio\n');
          clearInterval(autoImport);
        }
      },500);
    });

    // Reveal hub2 when Add More clicked (guarded so it won't error if button is commented out)
    const addMoreBtn = document.getElementById("addMoreBtn");
    if (addMoreBtn) {
      addMoreBtn.onclick = () => {
        const hub2 = document.getElementById("hub2");
        if (hub2) {
          hub2.style.display = "block";
        }
      };
    }

    // ========= SMART REPL AUTOSCROLL (polling-based, shadow-DOM safe) =========
    const replContainer = document.getElementById("replContainer");
    const SCROLL_THRESHOLD = 10;

    if (replContainer) {
      // If the user scrolls up, pause autoscroll until they scroll back to bottom
      replContainer.addEventListener('scroll', () => {
        const distanceFromBottom =
          replContainer.scrollHeight -
          replContainer.scrollTop -
          replContainer.clientHeight;
        autoScrollRepl = distanceFromBottom < SCROLL_THRESHOLD;
      });

      // Periodically snap to bottom while autoscroll is enabled
      setInterval(() => {
        if (!autoScrollRepl) return;
        replContainer.scrollTop = replContainer.scrollHeight;
      }, 200);
    }
  </script>
</body>
</html>

